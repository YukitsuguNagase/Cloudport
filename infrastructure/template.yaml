AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: CloudPort - AWS技術者マッチングプラットフォーム

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs20.x
    MemorySize: 256
    Architectures:
      - arm64
    Environment:
      Variables:
        USERS_TABLE: !Ref UsersTable
        JOBS_TABLE: !Ref JobsTable
        APPLICATIONS_TABLE: !Ref ApplicationsTable
        CONVERSATIONS_TABLE: !Ref ConversationsTable
        MESSAGES_TABLE: !Ref MessagesTable
        CONTRACTS_TABLE: !Ref ContractsTable
        NOTIFICATIONS_TABLE: !Ref NotificationsTable
        SCOUTS_TABLE: !Ref ScoutsTable

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Environment name

Resources:
  # API Gateway
  CloudPortApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Requested-With'"
        AllowOrigin: "'*'"
        MaxAge: "'600'"
      Auth:
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt UserPool.Arn
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Requested-With'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Requested-With'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"

  # Cognito User Pool
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub cloudport-users-${Environment}
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      UserAttributeUpdateSettings:
        AttributesRequireVerificationBeforeUpdate:
          - email
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
      Schema:
        - Name: email
          Required: true
          Mutable: false
        - Name: userType
          AttributeDataType: String
          Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub cloudport-client-${Environment}
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      GenerateSecret: false

  # DynamoDB Tables
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-users-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH

  JobsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-jobs-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: jobId
          AttributeType: S
        - AttributeName: companyId
          AttributeType: S
      KeySchema:
        - AttributeName: jobId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CompanyIdIndex
          KeySchema:
            - AttributeName: companyId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  ApplicationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-applications-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: applicationId
          AttributeType: S
        - AttributeName: jobId
          AttributeType: S
        - AttributeName: engineerId
          AttributeType: S
      KeySchema:
        - AttributeName: applicationId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: JobIdIndex
          KeySchema:
            - AttributeName: jobId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: EngineerIdIndex
          KeySchema:
            - AttributeName: engineerId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  ConversationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-conversations-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: conversationId
          AttributeType: S
        - AttributeName: engineerId
          AttributeType: S
        - AttributeName: companyId
          AttributeType: S
      KeySchema:
        - AttributeName: conversationId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EngineerIdIndex
          KeySchema:
            - AttributeName: engineerId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: CompanyIdIndex
          KeySchema:
            - AttributeName: companyId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  MessagesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-messages-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: messageId
          AttributeType: S
        - AttributeName: conversationId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
      KeySchema:
        - AttributeName: messageId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ConversationIdIndex
          KeySchema:
            - AttributeName: conversationId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  ContractsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-contracts-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: contractId
          AttributeType: S
        - AttributeName: engineerId
          AttributeType: S
        - AttributeName: companyId
          AttributeType: S
      KeySchema:
        - AttributeName: contractId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EngineerIdIndex
          KeySchema:
            - AttributeName: engineerId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: CompanyIdIndex
          KeySchema:
            - AttributeName: companyId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  NotificationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-notifications-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: notificationId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
      KeySchema:
        - AttributeName: notificationId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserIdIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  ScoutsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-scouts-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: scoutId
          AttributeType: S
        - AttributeName: companyId
          AttributeType: S
        - AttributeName: engineerId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
      KeySchema:
        - AttributeName: scoutId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CompanyIdIndex
          KeySchema:
            - AttributeName: companyId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: EngineerIdIndex
          KeySchema:
            - AttributeName: engineerId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # Lambda Functions - Jobs
  GetJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/getJobs.handler
      Events:
        GetJobs:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs
            Method: get
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  GetJobDetailFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/getJobDetail.handler
      Events:
        GetJobDetail:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}
            Method: get
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  CreateJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/createJob.handler
      Events:
        CreateJob:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable

  UpdateJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/updateJob.handler
      Events:
        UpdateJob:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable

  DeleteJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/deleteJob.handler
      Events:
        DeleteJob:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable

  # Lambda Functions - Applications
  ApplyJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/applications/applyJob.handler
      Events:
        ApplyJob:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}/apply
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable

  GetApplicationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/applications/getApplications.handler
      Events:
        GetMyApplications:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /applications
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        GetJobApplications:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}/applications
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  UpdateApplicationStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/applications/updateApplicationStatus.handler
      Events:
        UpdateApplicationStatus:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /applications/{applicationId}/status
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  # Lambda Functions - Users
  GetProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/users/getProfile.handler
      Events:
        GetProfile:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /users/me
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable

  UpdateProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/users/updateProfile.handler
      Events:
        UpdateProfile:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /users/me
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable

  GetUserProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/users/getUserProfile.handler
      Events:
        GetUserProfile:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /users/{userId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  # Lambda Functions - Messages
  CreateConversationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/createConversation.handler
      Events:
        CreateConversation:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /applications/{applicationId}/conversation
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  GetConversationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/getConversations.handler
      Events:
        GetConversations:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  SendMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/sendMessage.handler
      Events:
        SendMessage:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations/{conversationId}/messages
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable

  GetMessagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/getMessages.handler
      Events:
        GetMessages:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations/{conversationId}/messages
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref MessagesTable
        - DynamoDBReadPolicy:
            TableName: !Ref ConversationsTable

  MarkAsReadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/markAsRead.handler
      Events:
        MarkAsRead:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations/{conversationId}/read
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  GetConversationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/getConversation.handler
      Events:
        GetConversation:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations/{conversationId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  # Contract Functions
  CreateContractFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/createContract.handler
      Events:
        CreateContract:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  ApproveContractFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/approveContract.handler
      Events:
        ApproveContract:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts/{contractId}/approve
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable

  GetContractsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/getContracts.handler
      Events:
        GetContracts:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  GetContractDetailFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/getContractDetail.handler
      Events:
        GetContractDetail:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts/{contractId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  ProcessPaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/processPayment.handler
      Events:
        ProcessPayment:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts/{contractId}/payment
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable

  GetNotificationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/notifications/getNotifications.handler
      Events:
        GetNotifications:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /notifications
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref NotificationsTable

  MarkNotificationAsReadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/notifications/markAsRead.handler
      Events:
        MarkAsRead:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /notifications/{notificationId}/read
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable

  # Lambda Functions - Scouts
  SearchEngineersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/scouts/searchEngineers.handler
      Events:
        SearchEngineers:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /scouts/search
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  SendScoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/scouts/sendScout.handler
      Events:
        SendScout:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /scouts
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ScoutsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable

  GetScoutsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/scouts/getScouts.handler
      Events:
        GetScouts:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /scouts
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ScoutsTable

  GetMyJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/getMyJobs.handler
      Events:
        GetMyJobs:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/my
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub https://${CloudPortApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
