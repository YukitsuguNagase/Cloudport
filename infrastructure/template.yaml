AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: CloudPort - AWS技術者マッチングプラットフォーム

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs20.x
    MemorySize: 256
    Architectures:
      - arm64
    Environment:
      Variables:
        USERS_TABLE: !Ref UsersTable
        JOBS_TABLE: !Ref JobsTable
        APPLICATIONS_TABLE: !Ref ApplicationsTable
        CONVERSATIONS_TABLE: !Ref ConversationsTable
        MESSAGES_TABLE: !Ref MessagesTable
        CONTRACTS_TABLE: !Ref ContractsTable
        NOTIFICATIONS_TABLE: !Ref NotificationsTable
        SCOUTS_TABLE: !Ref ScoutsTable
        LOGIN_ATTEMPTS_TABLE: !Ref LoginAttemptsTable
        LOGIN_DEVICES_TABLE: !Ref LoginDevicesTable
        PAYMENT_ATTEMPTS_TABLE: !Ref PaymentAttemptsTable
        BLOCKED_IPS_TABLE: !Ref BlockedIPsTable
        SENDER_EMAIL: noreply@dotqinc.com

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Environment name

  PayjpSecretKeyParam:
    Type: String
    NoEcho: true
    Default: sk_test_c07bd8dfb391cb8bdc497b46
    Description: PAY.JP Secret Key (test or production)

  AdminAllowedIPs:
    Type: CommaDelimitedList
    Default: "138.64.83.96/32"
    Description: Comma-separated list of IP addresses allowed to access admin endpoints (CIDR notation)

Resources:
  # IAM Role for Cognito to send SMS via SNS
  CognitoSNSRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cognito-idp.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Sub cloudport-${Environment}-external
      Policies:
        - PolicyName: CognitoSNSPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: '*'

  # API Gateway
  CloudPortApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Requested-With'"
        AllowOrigin: "'*'"
        MaxAge: "'600'"
      Auth:
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt UserPool.Arn
        ResourcePolicy:
          CustomStatements:
            - Effect: Deny
              Principal: '*'
              Action: execute-api:Invoke
              Resource:
                - execute-api:/*/POST/admin/*
                - execute-api:/*/GET/admin/*
                - execute-api:/*/PUT/admin/*
                - execute-api:/*/DELETE/admin/*
              Condition:
                NotIpAddress:
                  aws:SourceIp: !Ref AdminAllowedIPs
            - Effect: Allow
              Principal: '*'
              Action: execute-api:Invoke
              Resource: execute-api:/*/*/*
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          ThrottlingBurstLimit: 100
          ThrottlingRateLimit: 50
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Requested-With'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Requested-With'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"

  # Cognito User Pool
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub cloudport-users-${Environment}
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      UserAttributeUpdateSettings:
        AttributesRequireVerificationBeforeUpdate:
          - email
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
      Schema:
        - Name: email
          Required: true
          Mutable: false
        - Name: name
          AttributeDataType: String
          Mutable: true
          Required: false
        - Name: userType
          AttributeDataType: String
          Mutable: true
        - Name: phone_number
          AttributeDataType: String
          Mutable: true
          Required: false
      MfaConfiguration: OPTIONAL
      EnabledMfas:
        - SOFTWARE_TOKEN_MFA
        - SMS_MFA
      SmsConfiguration:
        SnsCallerArn: !GetAtt CognitoSNSRole.Arn
        ExternalId: !Sub cloudport-${Environment}-external
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      DeviceConfiguration:
        ChallengeRequiredOnNewDevice: true
        DeviceOnlyRememberedOnUserPrompt: false
      LambdaConfig:
        PreAuthentication: !GetAtt PreAuthenticationFunction.Arn
        PostAuthentication: !GetAtt PostAuthenticationFunction.Arn
        DefineAuthChallenge: !GetAtt DefineAuthChallengeFunction.Arn

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub cloudport-client-${Environment}
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      GenerateSecret: false

  # DynamoDB Tables
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-users-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH

  JobsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-jobs-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: jobId
          AttributeType: S
        - AttributeName: companyId
          AttributeType: S
      KeySchema:
        - AttributeName: jobId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CompanyIdIndex
          KeySchema:
            - AttributeName: companyId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  ApplicationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-applications-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: applicationId
          AttributeType: S
        - AttributeName: jobId
          AttributeType: S
        - AttributeName: engineerId
          AttributeType: S
      KeySchema:
        - AttributeName: applicationId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: JobIdIndex
          KeySchema:
            - AttributeName: jobId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: EngineerIdIndex
          KeySchema:
            - AttributeName: engineerId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  ConversationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-conversations-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: conversationId
          AttributeType: S
        - AttributeName: engineerId
          AttributeType: S
        - AttributeName: companyId
          AttributeType: S
      KeySchema:
        - AttributeName: conversationId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EngineerIdIndex
          KeySchema:
            - AttributeName: engineerId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: CompanyIdIndex
          KeySchema:
            - AttributeName: companyId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  MessagesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-messages-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: messageId
          AttributeType: S
        - AttributeName: conversationId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
      KeySchema:
        - AttributeName: messageId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ConversationIdIndex
          KeySchema:
            - AttributeName: conversationId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  ContractsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-contracts-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: contractId
          AttributeType: S
        - AttributeName: engineerId
          AttributeType: S
        - AttributeName: companyId
          AttributeType: S
      KeySchema:
        - AttributeName: contractId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EngineerIdIndex
          KeySchema:
            - AttributeName: engineerId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: CompanyIdIndex
          KeySchema:
            - AttributeName: companyId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  NotificationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-notifications-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: notificationId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
      KeySchema:
        - AttributeName: notificationId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserIdIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  ScoutsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-scouts-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: scoutId
          AttributeType: S
        - AttributeName: companyId
          AttributeType: S
        - AttributeName: engineerId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
      KeySchema:
        - AttributeName: scoutId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CompanyIdIndex
          KeySchema:
            - AttributeName: companyId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: EngineerIdIndex
          KeySchema:
            - AttributeName: engineerId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  LoginAttemptsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-login-attempts-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: email
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  LoginDevicesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-login-devices-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: deviceId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: deviceId
          KeyType: RANGE

  PaymentAttemptsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-payment-attempts-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  BlockedIPsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub cloudport-blocked-ips-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: ipAddress
          AttributeType: S
      KeySchema:
        - AttributeName: ipAddress
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  # Lambda Functions - Jobs
  GetJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/getJobs.handler
      Events:
        GetJobs:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs
            Method: get
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  GetJobDetailFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/getJobDetail.handler
      Events:
        GetJobDetail:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}
            Method: get
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  CreateJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/createJob.handler
      Events:
        CreateJob:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable

  UpdateJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/updateJob.handler
      Events:
        UpdateJob:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable

  DeleteJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/deleteJob.handler
      Events:
        DeleteJob:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable

  # Lambda Functions - Applications
  ApplyJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/applications/applyJob.handler
      Events:
        ApplyJob:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}/apply
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable

  GetApplicationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/applications/getApplications.handler
      Events:
        GetMyApplications:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /applications
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        GetJobApplications:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/{jobId}/applications
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  UpdateApplicationStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/applications/updateApplicationStatus.handler
      Events:
        UpdateApplicationStatus:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /applications/{applicationId}/status
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  # Lambda Functions - Users
  GetProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/users/getProfile.handler
      Events:
        GetProfile:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /users/me
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable

  UpdateProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/users/updateProfile.handler
      Events:
        UpdateProfile:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /users/me
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable

  GetUserProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/users/getUserProfile.handler
      Events:
        GetUserProfile:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /users/{userId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  # Lambda Functions - Messages
  CreateConversationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/createConversation.handler
      Events:
        CreateConversation:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /applications/{applicationId}/conversation
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  GetConversationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/getConversations.handler
      Events:
        GetConversations:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  SendMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/sendMessage.handler
      Events:
        SendMessage:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations/{conversationId}/messages
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ContractsTable
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
              Resource:
                - !Sub '${ContractsTable.Arn}/index/*'

  GetMessagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/getMessages.handler
      Events:
        GetMessages:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations/{conversationId}/messages
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref MessagesTable
        - DynamoDBReadPolicy:
            TableName: !Ref ConversationsTable

  MarkAsReadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/markAsRead.handler
      Events:
        MarkAsRead:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations/{conversationId}/read
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  GetConversationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/getConversation.handler
      Events:
        GetConversation:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations/{conversationId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  DeleteConversationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/messages/deleteConversation.handler
      Events:
        DeleteConversation:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /conversations/{conversationId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable

  # Contract Functions
  CreateContractFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/createContract.handler
      Events:
        CreateContract:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  ApproveContractFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/approveContract.handler
      Events:
        ApproveContract:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts/{contractId}/approve
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable

  GetContractsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/getContracts.handler
      Events:
        GetContracts:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  GetContractDetailFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/getContractDetail.handler
      Events:
        GetContractDetail:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts/{contractId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  ProcessPaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/contracts/processPayment.handler
      Environment:
        Variables:
          PAYJP_SECRET_NAME: !Sub cloudport-payjp-secret-${Environment}
      Events:
        ProcessPayment:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /contracts/{contractId}/payment
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:cloudport-payjp-secret-${Environment}-*

  # Admin Functions
  GetAllContractsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/admin/getAllContracts.handler
      Events:
        GetAllContracts:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /admin/contracts
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  ProcessRefundFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/admin/processRefund.handler
      Environment:
        Variables:
          PAYJP_SECRET_NAME: !Sub cloudport-payjp-secret-${Environment}
      Events:
        ProcessRefund:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /admin/contracts/{contractId}/refund
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractsTable
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:cloudport-payjp-secret-${Environment}-*

  GetAllUsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/admin/getAllUsers.handler
      Events:
        GetAllUsers:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /admin/users
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  GetUserDetailFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/admin/getUserDetail.handler
      Events:
        GetUserDetail:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /admin/users/{userId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ApplicationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ContractsTable

  # Admin Security Functions
  BlockIPFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/admin/blockIP.handler
      Events:
        BlockIP:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /admin/security/block-ip
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref BlockedIPsTable

  UnblockIPFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/admin/unblockIP.handler
      Events:
        UnblockIP:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /admin/security/unblock-ip/{ipAddress}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref BlockedIPsTable

  GetBlockedIPsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/admin/getBlockedIPs.handler
      Events:
        GetBlockedIPs:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /admin/security/blocked-ips
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref BlockedIPsTable

  # MFA Management Functions
  SetupMFAFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/users/setupMFA.handler
      Events:
        SetupMFA:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /users/mfa/setup
            Method: post
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - cognito-idp:AssociateSoftwareToken
                - cognito-idp:VerifySoftwareToken
                - cognito-idp:SetUserMFAPreference
              Resource: !GetAtt UserPool.Arn

  GetMFAStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/users/getMFAStatus.handler
      Events:
        GetMFAStatus:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /users/mfa/status
            Method: get
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - cognito-idp:GetUser
              Resource: !GetAtt UserPool.Arn

  GetSystemLogsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/admin/getSystemLogs.handler
      Events:
        GetSystemLogs:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /admin/logs/system
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - logs:FilterLogEvents
                - logs:DescribeLogGroups
                - logs:DescribeLogStreams
              Resource: '*'

  GetAccessLogsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/admin/getAccessLogs.handler
      Events:
        GetAccessLogs:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /admin/logs/access
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  GetNotificationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/notifications/getNotifications.handler
      Events:
        GetNotifications:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /notifications
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref NotificationsTable

  MarkNotificationAsReadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/notifications/markAsRead.handler
      Events:
        MarkAsRead:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /notifications/{notificationId}/read
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable

  # Lambda Functions - Scouts
  SearchEngineersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/scouts/searchEngineers.handler
      Events:
        SearchEngineers:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /scouts/search
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable

  SendScoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/scouts/sendScout.handler
      Events:
        SendScout:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /scouts
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ScoutsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable

  GetScoutsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/scouts/getScouts.handler
      Events:
        GetScouts:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /scouts
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ScoutsTable

  GetMyJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/getMyJobs.handler
      Events:
        GetMyJobs:
          Type: Api
          Properties:
            RestApiId: !Ref CloudPortApi
            Path: /jobs/my
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref JobsTable

  # Cognito Lambda Triggers
  PreAuthenticationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/auth/preAuthentication.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref LoginAttemptsTable
        - DynamoDBReadPolicy:
            TableName: !Ref BlockedIPsTable
        - SESCrudPolicy:
            IdentityName: "*"

  PostAuthenticationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/auth/postAuthentication.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref LoginAttemptsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref LoginDevicesTable
        - SESCrudPolicy:
            IdentityName: "*"

  DefineAuthChallengeFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/
      Handler: dist/handlers/auth/defineAuthChallenge.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref LoginAttemptsTable

  # Cognito Lambda Trigger Permissions
  PreAuthenticationFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PreAuthenticationFunction
      Principal: cognito-idp.amazonaws.com
      Action: lambda:InvokeFunction
      SourceArn: !GetAtt UserPool.Arn

  PostAuthenticationFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PostAuthenticationFunction
      Principal: cognito-idp.amazonaws.com
      Action: lambda:InvokeFunction
      SourceArn: !GetAtt UserPool.Arn

  DefineAuthChallengeFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DefineAuthChallengeFunction
      Principal: cognito-idp.amazonaws.com
      Action: lambda:InvokeFunction
      SourceArn: !GetAtt UserPool.Arn

  # SNS Topic for CloudWatch Alarms
  SecurityAlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub cloudport-${Environment}-security-alarms
      DisplayName: CloudPort Security Alarms
      Subscription:
        - Endpoint: yukinag@dotqinc.com
          Protocol: email

  # CloudWatch Alarms for Security Monitoring
  UnauthorizedApiCallsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub cloudport-${Environment}-unauthorized-api-calls
      AlarmDescription: Alert on high number of 401/403 errors
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref SecurityAlarmTopic
      Dimensions:
        - Name: ApiName
          Value: !Ref CloudPortApi

  PaymentErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub cloudport-${Environment}-payment-errors
      AlarmDescription: Alert on payment processing errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref SecurityAlarmTopic
      Dimensions:
        - Name: FunctionName
          Value: !Ref ProcessPaymentFunction

  RefundErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub cloudport-${Environment}-refund-errors
      AlarmDescription: Alert on refund processing errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref SecurityAlarmTopic
      Dimensions:
        - Name: FunctionName
          Value: !Ref ProcessRefundFunction

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub https://${CloudPortApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
